{% extends 'base.html' %}
{% load tailwind_filters %}
{% load widget_tweaks %}
{% load static %}
{% block meta %}<meta name="robots" content="noindex,nofollow">{% endblock %}
{% block title %}Edit House - {{ house.title }} - NyumbaFinder KE{% endblock %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
    /* Isolate Leaflet from Tailwind */
    .leaflet-container {
        background: #d4d4d8 !important;
        font-family: inherit !important;
    }
    
    .leaflet-container * {
        box-sizing: content-box !important;
    }
    
    /* Quill editor styling */
    .ql-toolbar {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
        border-bottom: 1px solid #ccc !important;
    }
    
    .ql-container {
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
        height: 200px;
    }

    .ql-editor {
        background: white;
        color: black;
    }
    
    /* Image preview styling */
    .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
    }

    /* Map container with search box */
    .map-container {
        position: relative;
        width: 100%;
        height: 384px;
        border-radius: 0.75rem;
        overflow: hidden;
        border: 2px solid var(--primary);
        background-color: #d4d4d8;
    }

    /* Search box styling */
    .search-box {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 1000;
        background: white;
        padding: 12px;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        width: 320px;
        max-width: 90%;
    }

    .search-box input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 8px 12px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
    }

    .search-box input:focus {
        border-color: #6366f1;
        ring: 2px solid #6366f1;
    }

    .search-box button {
        background: #6366f1;
        color: white;
        padding: 8px 16px;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    .search-box button:hover {
        background: #5b5cdd;
    }

    .search-box button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Loading spinner */
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Current images styling */
    .current-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .image-preview-item {
        position: relative;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,.1);
        transition: all 0.3s ease;
    }

    .image-preview-item:hover {
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .current-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
</style>

<div class="min-h-screen bg-[var(--bg)] py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-3">Edit Your House</h1>
            <p class="text-gray-400">Update your property listing</p>
        </div>

        <!-- Only owner can edit -->
        {% if house.owner != request.user %}
            <div class="bg-red-600 text-white rounded-2xl p-6 text-center">
                <h3 class="text-xl font-bold mb-3">Access Denied</h3>
                <p class="mb-4">You can only edit houses you posted.</p>
                <a href="{% url 'dashboard' %}" class="bg-white text-red-600 px-6 py-2 rounded-xl font-semibold hover:bg-gray-100 transition">
                    Back to Dashboard
                </a>
            </div>
        {% else %}

        <!-- Display form non-field errors -->
        {% if form.non_field_errors %}
            <div class="bg-red-600 text-white p-4 rounded-xl mb-6">
                <h3 class="font-bold mb-2">Please fix the following errors:</h3>
                <ul class="list-disc list-inside">
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="space-y-8" novalidate>
        {% comment %} onsubmit="return validateForm()" {% endcomment %}
            {% csrf_token %}

            <!-- HOUSE DETAILS SECTION -->
            <div class="bg-[var(--bg-light)] rounded-2xl p-6 border border-[var(--border)]">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    House Details
                </h2>
                
                <div class="space-y-4">
                    <!-- Title -->
                    <div>
                        <label for="{{ form.title.id_for_label }}" class="block text-white font-medium mb-2">{{ form.title.label }} *</label>
                        {{ form.title|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                        {% if form.title.errors %}
                            <div class="text-red-400 text-sm mt-1">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- House Type -->
                    <div>
                        <label for="{{ form.house_type.id_for_label }}" class="block text-white font-medium mb-2">{{ form.house_type.label }} *</label>
                        {{ form.house_type|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                        {% if form.house_type.errors %}
                            <div class="text-red-400 text-sm mt-1">{{ form.house_type.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="{{ form.description.id_for_label }}" class="block text-white font-medium mb-2">{{ form.description.label }} *</label>
                        {{ form.description|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                        {% if form.description.errors %}
                            <div class="text-red-400 text-sm mt-1">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Rent and Deposit -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ form.rent.id_for_label }}" class="block text-white font-medium mb-2">{{ form.rent.label }} *</label>
                            {{ form.rent|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                            {% if form.rent.errors %}
                                <div class="text-red-400 text-sm mt-1">{{ form.rent.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.deposit.id_for_label }}" class="block text-white font-medium mb-2">{{ form.deposit.label }} *</label>
                            {{ form.deposit|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                            {% if form.deposit.errors %}
                                <div class="text-red-400 text-sm mt-1">{{ form.deposit.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- House Number and Floor -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ form.house_number.id_for_label }}" class="block text-white font-medium mb-2">{{ form.house_number.label }} *</label>
                            {{ form.house_number|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                            {% if form.house_number.errors %}
                                <div class="text-red-400 text-sm mt-1">{{ form.house_number.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.floor_number.id_for_label }}" class="block text-white font-medium mb-2">{{ form.floor_number.label }}</label>
                            {{ form.floor_number|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                            {% if form.floor_number.errors %}
                                <div class="text-red-400 text-sm mt-1">{{ form.floor_number.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- LOCATION SECTION -->
            <div class="bg-[var(--bg-light)] rounded-2xl p-6 border border-[var(--border)]">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Location Details
                </h2>
                
                <!-- Location Input -->
                <div class="mb-4">
                    <label for="{{ form.location.id_for_label }}" class="block text-white font-medium mb-2">{{ form.location.label }} *</label>
                    {{ form.location|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white focus:border-[var(--primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" }}
                    {% if form.location.errors %}
                        <div class="text-red-400 text-sm mt-1">{{ form.location.errors }}</div>
                    {% endif %}
                </div>

                <p class="text-gray-400 mb-4">Current location (drag marker to update):</p>

                <!-- Map Container -->
                <div class="map-container">
                    <div class="search-box">
                        <div class="flex gap-2">
                            <input type="text" id="address-search" class="flex-1" placeholder="Search new location..." value="">
                            <button type="button" onclick="searchAddress()" id="search-button">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="map" class="w-full h-full"></div>
                </div>

                <!-- Coordinates Display -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="{{ form.latitude.id_for_label }}" class="block text-white font-medium mb-2">{{ form.latitude.label }} *</label>
                        {{ form.latitude|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white text-center font-mono" }}
                        {% if form.latitude.errors %}
                            <div class="text-red-400 text-sm mt-1">{{ form.latitude.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.longitude.id_for_label }}" class="block text-white font-medium mb-2">{{ form.longitude.label }} *</label>
                        {{ form.longitude|add_class:"w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white text-center font-mono" }}
                        {% if form.longitude.errors %}
                            <div class="text-red-400 text-sm mt-1">{{ form.longitude.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- CURRENT IMAGES SECTION -->
            {% if house.images.exists %}
            <div class="bg-[var(--bg-light)] rounded-2xl p-6 border border-[var(--border)]">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Current Photos
                </h2>
                <p class="text-gray-400 mb-4">Click the X to remove images</p>
                
                <div class="current-images-grid">
                    {% for img in house.images.all %}
                        <div class="image-preview-item">
                            <img src="{{ img.image.url }}" class="current-image" alt="House image {{ forloop.counter }}">
                            <form method="post" action="{% url 'delete_house_image' img.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="remove-image" 
                                        onclick="return confirm('Are you sure you want to delete this image?')">
                                    Ã—
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ADD NEW IMAGES SECTION -->
            <div class="bg-[var(--bg-light)] rounded-2xl p-6 border border-[var(--border)]">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add More Photos
                </h2>
                <p class="text-gray-400 mb-4">Upload additional images (max 15 total including current ones)</p>
                
                <input type="file" class="w-full bg-[var(--bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary)] file:text-white hover:file:bg-[var(--primary-light)]" 
                       id="newImages" name="new_images" multiple accept="image/*" onchange="previewNewImages(this)">
                
                <div id="new-images-preview" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4"></div>
            </div>

            <!-- TERMS SECTION WITH QUILL -->
            <div class="bg-[var(--bg-light)] rounded-2xl p-6 border mt-2 mb-2 border-[var(--border)]">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Rental Terms
                </h2>
                <p class="text-xs text-gray-400 mb-4">Update your rental terms with rich text editing</p>
                
                <!-- Quill Editor -->
                <div id="terms-editor" style="background: white; border-radius: 0.5rem;"></div>
                <input type="hidden" id="terms-content" name="terms">
                
                <div class="mt-3">
                    <small class="text-xs text-gray-400">
                        ðŸ’¡ <strong>Formatting tips:</strong> Use bullet points for rules, bold for important terms.
                    </small>
                </div>
            </div>

            <!-- SUBMIT BUTTONS -->
            <div class="text-center mt-6">
                <button type="submit" class="bg-[var(--primary)] text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-[var(--primary-light)] transition transform hover:scale-105">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    UPDATE HOUSE INFORMATION
                </button>
                <div>
                    <a href="{% url 'dashboard' %}" class="text-gray-400 hover:text-white transition inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancel and return to dashboard
                    </a>
                </div>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Map variables
    let map, marker;
    let quill;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing map and editor');
        initializeMap();
        initializeQuill();

        // Add form submission handler PROPERLY
        setupFormSubmission();
    });

    function initializeMap() {
        // Use house coordinates or default to Nairobi
        const lat = {{ house.latitude|default:"-1.2921" }};
        const lng = {{ house.longitude|default:"36.8219" }};

        // Initialize map
        map = L.map('map').setView([lat, lng], 16);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Create custom marker
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="width: 24px; height: 24px; background: #6366f1; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // Add draggable marker
        marker = L.marker([lat, lng], {
            icon: customIcon,
            draggable: true
        }).addTo(map);

        marker.bindPopup("<b>Your Property</b><br>Drag to adjust location").openPopup();

        // Update coordinates when marker is moved
        function updateCoordinates() {
            const position = marker.getLatLng();
            document.getElementById('id_latitude').value = position.lat.toFixed(6);
            document.getElementById('id_longitude').value = position.lng.toFixed(6);
        }

        marker.on('dragend', updateCoordinates);

        // Update coordinates when map is clicked
        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            updateCoordinates();
            map.panTo(e.latlng);
        });

        // Initial coordinate update
        updateCoordinates();

        // Handle map resize
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }

    function initializeQuill() {
        // Initialize Quill editor
        quill = new Quill('#terms-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link'],
                    ['clean']
                ]
            },
            placeholder: 'Update your rental terms here...'
        });

        // Set existing terms content
        const existingTerms = `{{ terms_html|safe }}`;
        if (existingTerms && existingTerms.trim() !== '') {
            quill.root.innerHTML = existingTerms;
        }
    }

    function searchAddress() {
        const query = document.getElementById('address-search').value.trim();
        if (!query) {
            alert('Please enter a location to search for.');
            return;
        }

        // Show loading state
        const searchButton = document.getElementById('search-button');
        const originalContent = searchButton.innerHTML;
        searchButton.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>';
        searchButton.disabled = true;

        // Add Kenya to the search query for better results
        const searchQuery = query.includes('Kenya') || query.includes('Nairobi') ? query : `${query}, Nairobi, Kenya`;
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&countrycodes=ke`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    // Update marker position
                    marker.setLatLng([lat, lon]);
                    
                    // Center map on the location with higher zoom
                    map.setView([lat, lon], 16);
                    
                    // Update coordinate fields
                    document.getElementById('id_latitude').value = lat.toFixed(6);
                    document.getElementById('id_longitude').value = lon.toFixed(6);
                    
                    // Update location input field
                    document.getElementById('id_location').value = result.display_name;
                    
                    // Show success message in popup
                    marker.bindPopup(`<b>Location Found</b><br>${result.display_name}<br>Drag marker to adjust exact position`).openPopup();
                    
                } else {
                    alert('Location not found. Please try a different search term.\n\nTry: "Karen, Nairobi" or "Westlands, Nairobi"');
                }
            })
            .catch(error => {
                console.error('Error searching address:', error);
                alert('Error searching for location. Please check your internet connection and try again.');
            })
            .finally(() => {
                // Restore button state
                searchButton.innerHTML = originalContent;
                searchButton.disabled = false;
            });
    }

    // New images preview function
    function previewNewImages(input) {
        const preview = document.getElementById('new-images-preview');
        preview.innerHTML = '';
        
        const files = input.files;
        
        // Validate number of files (considering existing images)
        const currentImageCount = {{ house.images.count }};
        if (currentImageCount + files.length > 15) {
            alert(`You can only have 15 images total. You currently have ${currentImageCount} images. Please select ${15 - currentImageCount} or fewer images.`);
            input.value = '';
            return;
        }
        
        // Validate each file
        for (let file of files) {
            // Check file size (20MB)
            if (file.size > 20 * 1024 * 1024) {
                alert(`Image ${file.name} is too large. Maximum size is 20MB.`);
                input.value = '';
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert(`File ${file.name} is not a valid image.`);
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg border border-[var(--border)]">
                    <button type="button" class="remove-image" onclick="this.parentElement.remove(); updateFileInput();">
                        Ã—
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        }
    }

    // Update file input when images are removed from preview
    function updateFileInput() {
        // This would require more complex handling with a FileList
        // For simplicity, we'll just alert the user to reselect files if they remove from preview
        console.log('Image removed from preview. Note: File input still contains the original selection.');
    }

    function setupFormSubmission() {
        const form = document.querySelector('form');
        console.log('Setting up form submission handler');
        
        if (!form) {
            console.error('FORM NOT FOUND!');
            return;
        }
        
        // Remove any existing event listeners by cloning the form
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        // Get the new form reference
        const cleanForm = document.querySelector('form');
        
        cleanForm.addEventListener('submit', function(e) {
            console.log('=== FORM SUBMISSION HANDLER TRIGGERED ===');
            console.log('Event type:', e.type);
            console.log('Default prevented?', e.defaultPrevented);
            
            // Get Quill content and put it in hidden input
            const termsContent = quill.root.innerHTML;
            document.getElementById('terms-content').value = termsContent;
            console.log('Terms content set:', termsContent);
            
            // DON'T prevent default - let it submit
            console.log('Allowing form to submit normally...');
        });
        
        console.log('Form submission handler setup complete');
    }

    function testFormSubmission() {
        console.log('=== TESTING FORM SUBMISSION ===');
        const form = document.querySelector('form');
        const submitButton = form.querySelector('button[type="submit"]');
        
        // Add click listener to submit button
        if (submitButton) {
            submitButton.addEventListener('click', function(e) {
                console.log('=== SUBMIT BUTTON CLICKED ===');
                console.log('Button text:', this.textContent.trim());
                console.log('Button type:', this.type);
                console.log('Form valid:', form.checkValidity());
                
                // Check if button is disabled
                console.log('Button disabled:', this.disabled);
                
                // Check all required fields
                const requiredFields = form.querySelectorAll('[required]');
                console.log('Required fields count:', requiredFields.length);
                
                requiredFields.forEach(field => {
                    console.log(`Field: ${field.name}, Value: "${field.value}", Valid: ${field.checkValidity()}`);
                });
            });
        }
        
        // Test manual submission
        window.forceSubmit = function() {
            console.log('=== FORCE SUBMITTING FORM ===');
            const termsContent = quill.root.innerHTML;
            document.getElementById('terms-content').value = termsContent;
            
            console.log('Calling form.submit()...');
            form.submit();
            console.log('form.submit() called');
        };
    }
    function validateForm() {
        console.log('Form submission started...');
        
        // Get Quill content and put it in hidden input
        const termsContent = quill.root.innerHTML;
        const plainText = quill.getText().trim();
        
        console.log('Quill HTML:', termsContent);
        console.log('Quill Plain Text:', plainText);
        
        // Update the hidden input
        document.getElementById('terms-content').value = termsContent;
        
        // Validate terms content
        if (!plainText || plainText === '' || plainText === '\n\n' || plainText.length < 5) {
            alert('Please enter at least one rental term in the Rental Terms section.');
            return false;
        }
        
        // Additional validation for coordinates
        const lat = document.getElementById('id_latitude').value;
        const lng = document.getElementById('id_longitude').value;
        if (!lat || !lng) {
            alert('Please set the location by searching or clicking on the map.');
            return false;
        }
        
        console.log('All validations passed, submitting form...');
        return true;
    }
</script>
{% endblock %}
<!-- payments/processing.html -->
{% extends "base.html" %}
{% block meta %}<meta name="robots" content="noindex,nofollow">{% endblock %}
{% block title %}Payment Processing... - NyumbaFinder KE{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-900 to-black py-1">
    <div class="max-w-lg mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="relative w-24 h-24 mx-auto mb-6">
                <!-- Animated circles -->
                <div class="absolute inset-0 border-4 border-emerald-500/30 rounded-full animate-ping"></div>
                <div class="absolute inset-4 border-4 border-emerald-500/50 rounded-full"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-12 h-12 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl font-bold text-white mb-3">Complete Payment on Your Phone</h1>
            <p class="text-gray-400">Check your M-Pesa and enter PIN when prompted</p>
        </div>

        <!-- Instructions Card -->
        <div class="bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-2xl p-8 mb-6">
            <div class="space-y-6">
                <!-- Phone Display -->
                <div class="bg-gray-900/50 rounded-xl p-6 text-center">
                    <div class="text-gray-400 text-sm mb-2">Payment request sent to</div>
                    <div class="text-2xl font-bold text-white mb-1">+{{ payment.phone_number }}</div>
                    <div class="text-emerald-400 text-sm">Check this phone for M-Pesa prompt</div>
                </div>

                <!-- Step-by-step Guide -->
                <div class="space-y-4">
                    <h3 class="text-white font-bold text-lg flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        What to do next:
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex items-start gap-4 p-3 bg-gray-900/30 rounded-lg border border-gray-700">
                            <div class="w-8 h-8 bg-emerald-900/30 text-emerald-400 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="font-bold">1</span>
                            </div>
                            <div>
                                <h4 class="text-white font-medium">Check your phone</h4>
                                <p class="text-gray-400 text-sm mt-1">Look for an M-Pesa payment request from "NyumbaFinder"</p>
                            </div>
                        </div>

                        <div class="flex items-start gap-4 p-3 bg-gray-900/30 rounded-lg border border-gray-700">
                            <div class="w-8 h-8 bg-emerald-900/30 text-emerald-400 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="font-bold">2</span>
                            </div>
                            <div>
                                <h4 class="text-white font-medium">Enter your PIN</h4>
                                <p class="text-gray-400 text-sm mt-1">Enter your M-Pesa PIN when prompted to authorize KES {{ request.session.amount }}</p>
                            </div>
                        </div>

                        <div class="flex items-start gap-4 p-3 bg-gray-900/30 rounded-lg border border-gray-700">
                            <div class="w-8 h-8 bg-emerald-900/30 text-emerald-400 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="font-bold">3</span>
                            </div>
                            <div>
                                <h4 class="text-white font-medium">Wait for confirmation</h4>
                                <p class="text-gray-400 text-sm mt-1">Your listing will activate automatically within seconds</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timer -->
                <div class="text-center">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-gray-900/50 rounded-full">
                        <svg class="w-5 h-5 text-emerald-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-gray-300">Waiting for payment...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- house Preview -->
        <div class="bg-gray-800/30 border border-gray-700 rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white font-bold">Your Listing</h3>
                <span class="px-3 py-1 bg-gray-900 text-gray-400 text-sm rounded-full">Pending Activation</span>
            </div>
            
            <div class="flex items-start gap-4">
                {% if house.images.first %}
                <img src="{{ house.images.first.image.url }}" 
                     alt="{{ house.title }}"
                     class="w-16 h-16 rounded-xl object-cover">
                {% endif %}
                <div class="flex-1">
                    <h4 class="text-white font-medium mb-1">{{ house.title }}</h4>
                    <p class="text-gray-400 text-sm">{{ house.location|truncatechars:50 }}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-emerald-400 font-bold">KES {{ house.rent|floatformat:0 }}</span>
                        <span class="text-gray-500 text-sm">/month</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 grid grid-cols-2 gap-4">
            <button onclick="checkPaymentStatus()" 
                    id="checkStatusBtn"
                    class="bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Check Status
            </button>
            
            <button onclick="resendPaymentRequest()" 
                    id="resendBtn"
                    class="bg-gray-700 text-white py-4 rounded-xl font-bold hover:bg-gray-600 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Resend Request
            </button>
        </div>

        <!-- Help Section -->
        <div class="mt-8 border-t border-gray-700 pt-6">
            <div class="space-y-4">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-blue-900/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h4 class="text-white font-medium mb-1">Didn't receive the request?</h4>
                        <p class="text-gray-400 text-sm">
                            • Ensure phone <strong class="text-white">+{{ payment.phone_number }}</strong> is correct<br>
                            • Check your phone signal and try again<br>
                            • Make sure you have sufficient M-Pesa balance
                        </p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-amber-900/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h4 class="text-white font-medium mb-1">Need immediate help?</h4>
                        <p class="text-gray-400 text-sm">
                            Call our support team: 
                            <a href="tel:+254700000000" class="text-emerald-400 font-bold">0700 000 000</a><br>
                            Reference: <code class="text-gray-300">PAY{{ payment.id|stringformat:"06d" }}</code>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let checkCount = 0;
const maxChecks = 5; // 2.5 minutes (5 seconds × 30)

function checkPaymentStatus() {
    checkCount++;
    const button = document.getElementById('checkStatusBtn');
    const originalText = button.innerHTML;
    
    // Show loading
    button.innerHTML = `
        <div class="flex items-center justify-center gap-2">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            <span>Checking...</span>
        </div>
    `;
    button.disabled = true;
    
    // AJAX call to check status
    fetch(`/payment/check/{{ payment.id }}/`)
        .then(response => response.json())
        .then(data => {
            console.log(data);

            if (data.redirect_url) {
                console.log("Redirecting to:", data.redirect_url);
                window.location.href = data.redirect_url;
                return;  // STOP further execution
            } else if (checkCount >= maxChecks) {
                alert('Payment timeout. Please try again or contact support.');
                window.location.reload();
                return;
            } else {
                // Still pending
                button.innerHTML = originalText;
                button.disabled = false;
                setTimeout(() => {
                    if (checkCount < maxChecks) {
                        checkPaymentStatus();
                    }
                }, 6000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function resendPaymentRequest() {
    const button = document.getElementById('resendBtn');
    const originalText = button.innerHTML;
    
    button.innerHTML = `
        <div class="flex items-center justify-center gap-2">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            <span>Resending...</span>
        </div>
    `;
    button.disabled = true;
    
    // AJAX call to resend
    fetch(`/payment/resend/{{ payment.id }}/`)
        .then(response => response.json())
        .then(data => {
            console.log("Data ==> " + JSON.stringify(data));
            if (data.success) {
                alert('Payment request resent! Check your phone again.');
            } else {
                alert('Failed to resend. Please try again.');
            }
            button.innerHTML = originalText;
            button.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error. Please try again.');
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

// Auto-check every 5 seconds
setTimeout(checkPaymentStatus, 5000);
</script>
{% endblock %}